name: CI

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  test:
    name: Test
    timeout-minutes: 15
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 4
      - uses: pnpm/action-setup@v3
        with:
          version: 9
      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install
      - name: Validate and inject secret into .env.test
        env:
          RPC_PROVIDER_URLS_421614: ${{ secrets.RPC_PROVIDER_URLS_421614 }}
          RPC_PROVIDER_URLS_998: ${{ secrets.RPC_PROVIDER_URLS_998 }}
          RPC_PROVIDER_URLS_42161: ${{ secrets.RPC_PROVIDER_URLS_42161 }}
          RPC_PROVIDER_URLS_999: ${{ secrets.RPC_PROVIDER_URLS_999 }}
          RPC_PROVIDER_URLS_34268394551451: ${{ secrets.RPC_PROVIDER_URLS_34268394551451 }}
          RPC_PROVIDER_URLS_1: ${{ secrets.RPC_PROVIDER_URLS_1 }}
        run: |
          # Safely append the secret, prefixed with a newline.
          # This prevents file corruption.
          printf '\n%s\n' "RPC_PROVIDER_URLS_421614=$RPC_PROVIDER_URLS_421614" >> .env.test
          printf '\n%s\n' "RPC_PROVIDER_URLS_998=$RPC_PROVIDER_URLS_998" >> .env.test
          printf '\n%s\n' "RPC_PROVIDER_URLS_42161=$RPC_PROVIDER_URLS_42161" >> .env.test
          printf '\n%s\n' "RPC_PROVIDER_URLS_999=$RPC_PROVIDER_URLS_999" >> .env.test
          printf '\n%s\n' "RPC_PROVIDER_URLS_34268394551451=$RPC_PROVIDER_URLS_34268394551451" >> .env.test
          printf '\n%s\n' "RPC_PROVIDER_URLS_1=$RPC_PROVIDER_URLS_1" >> .env.test
      - name: Run tests using docker
        run: pnpm test:e2e:docker
  build:
    name: Build
    timeout-minutes: 15
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 4
      - uses: pnpm/action-setup@v3
        with:
          version: 9
      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install
      - name: Build
        run: pnpm build
  lint-check:
    name: Lint check
    timeout-minutes: 15
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 4
      - uses: pnpm/action-setup@v3
        with:
          version: 9
      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install
      - name: Build
        run: pnpm build
      - name: Lint check
        run: pnpm check
